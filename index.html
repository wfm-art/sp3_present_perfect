<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Present Perfect Master</title>
    
    <style>
        :root {
            /* Paleta Azul Est√°ndar */
            --primary: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #ffc107;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: var(--primary);
            --tab-text: #bbb;
            --tab-active-text: #ffffff;
            --border-color: #444;
            --light-gray-bg: #2a2a20;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        header {
            background: var(--header-bg);
            color: white;
            padding: 25px 35px;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .control-button:hover { background: rgba(255,255,255,0.4); }

        /* Pesta√±as */
        .main-tab-nav {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 3px solid var(--dark-blue);
        }
        .main-tab-nav button {
            background-color: inherit; border: none; outline: none; cursor: pointer;
            padding: 18px 25px; transition: 0.3s; font-size: 1.1em;
            font-weight: bold; color: var(--tab-text); flex-grow: 1;
        }
        .main-tab-nav button:hover { background-color: var(--border-color); }
        .main-tab-nav button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos Generales */
        h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px; font-size: 1.8em; margin-top: 0; }
        h3 { color: var(--green); font-size: 1.4em; margin-top: 25px; }
        .accent { color: var(--primary); font-weight: bold; }
        
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;}
        
        /* Bridge Visual */
        .bridge-visual {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--light-gray-bg);
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed var(--border-color);
            margin-bottom: 20px;
        }
        .bridge-step { flex: 1; text-align: center; }
        .bridge-arrow { font-size: 2.5em; color: var(--primary); font-weight: bold; display: block;}
        .bridge-icon { font-size: 3.5em; display: block; margin-bottom: 10px; }
        .rule-box { background: #e3f2fd; border: 1px solid #90caf9; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: left;}
        body.dark-mode .rule-box { background: #1e2a36; border-color: #444; }

        /* Video */
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; background: #000; margin-top: 20px; border: 1px solid var(--border-color); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        /* Visualizer */
        .formula-visualizer { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px; }
        .formula-part { padding: 8px 12px; border-radius: 5px; background-color: var(--container-bg); border: 1px solid var(--border-color); margin: 0 5px; display: inline-block; font-size: 1.2em; font-weight: bold; }
        .plus-sign { font-weight: bold; color: var(--primary); font-size: 1.2em; }

        /* The Helper Grid */
        .haber-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .haber-box {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: bold;
            font-size: 1.2em;
        }
        .haber-box:hover { transform: translateY(-3px); background: var(--dark-blue); }

        /* Irregulars */
        .acronym-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
        .acronym-card {
            width: 100px; height: 100px;
            perspective: 1000px;
            cursor: pointer;
        }
        .acronym-inner {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .acronym-card.flipped .acronym-inner { transform: rotateY(180deg); }
        
        .acronym-front, .acronym-back {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .acronym-front { background: var(--yellow); color: #333; font-size: 2em; font-weight: bold; border: 2px solid #e0a800; }
        .acronym-back { background: var(--dark-blue); color: white; transform: rotateY(180deg); font-size: 0.85em; text-align: center; padding: 2px; }

        /* Practice */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background-color: var(--primary); color: white; border:none; border-radius: 4px; cursor: pointer;}
        .quiz-question { margin-bottom: 15px; background: var(--light-gray-bg); padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary); }
        .quiz-question input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; width: 180px; }
        .quiz-question button { background-color: var(--green); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }

        /* Drag & Drop */
        .dropzone-container { display: flex; gap: 20px; margin-top: 20px; }
        .dropzone { flex: 1; min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; }
        .dropzone.drag-over { background-color: #e9ecef; border-color: var(--primary); }
        .dropzone h4 { text-align: center; margin-top: 0; color: var(--dark-blue); }
        
        .draggable { 
            display: inline-block; background: var(--container-bg); border: 1px solid #ccc; 
            padding: 8px 12px; margin: 5px; border-radius: 20px; 
            cursor: grab; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .draggable.dragging { opacity: 0.5; border: 2px dashed var(--primary); }
        #drag-pool { min-height: 80px; background: var(--tab-bg); border-radius: 8px; padding: 15px; margin-bottom: 10px; }

        /* Flashcards */
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin: 0 auto 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; font-size: 1.4em; border-radius: 10px; box-sizing: border-box; white-space: normal; word-break: break-word; }
        .card-front { background: var(--container-bg); border: 2px solid var(--primary); color: var(--text-color); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        .card-back p { margin: 10px 0 0; font-size: 0.8em; color: var(--text-color); opacity: 0.8; }
        body.dark-mode .card-back { color: var(--text-color); }
        .flashcard-nav { text-align: center; }
        .btn-fc { background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; margin: 0 5px; }
        .btn-fc.flip { background-color: var(--primary); }
        
        .tts-icon { font-size: 1.1em; cursor: pointer; margin-left: 8px; transition: transform 0.2s; }
        .tts-icon:hover { transform: scale(1.2); }
    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-button" onclick="toggleLang()">EN / ES</button>
                <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Present Perfect</h1>
            <p data-lang-key="header_subtitle">The Bridge: Connecting Past & Present üåâ</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_metaphor">üåâ The Concept</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formation')" data-lang-key="tab_formation">‚úçÔ∏è Formula</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practice')" data-lang-key="tab_practice">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_flashcards">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">The Bridge Metaphor</h2>
                
                <div class="bridge-visual">
                    <div class="bridge-step">
                        <span class="bridge-icon">‚è™</span>
                        <strong data-lang-key="bridge_past">PAST</strong><br>
                        <small data-lang-key="bridge_past_desc">Completed action</small>
                    </div>
                    <div class="bridge-step" style="flex: 2;">
                        <span class="bridge-icon">üåâ</span>
                        <strong data-lang-key="bridge_link">The Bridge</strong><br>
                        <div class="rule-box">
                            <strong>Rule:</strong> <span data-lang-key="rule_desc">Use <em>Haber</em> + <em>Participio</em> to connect the past to the present.</span>
                        </div>
                    </div>
                    <div class="bridge-step">
                        <span class="bridge-icon">üëá</span>
                        <strong data-lang-key="bridge_pres">PRESENT</strong><br>
                        <small data-lang-key="bridge_pres_desc">Relevant now</small>
                    </div>
                </div>

                <h3 data-lang-key="video_title">Video Tutorial</h3>
                <div class="video-container">
                    <iframe src="https://drive.google.com/file/d/1Ez-tCYUf3rnTImlgoRKYdsewhWE9iOzN/preview" allow="autoplay"></iframe>
                </div>

                <h3 style="margin-top:30px;" data-lang-key="viz_title">Formula Visualizer</h3>
                <div class="formula-visualizer">
                    <p data-lang-key="viz_desc">Click to build the structure.</p>
                    <div style="font-size: 2em; margin-bottom: 15px;">
                        <span class="formula-part" onclick="speak('Yo he')">Yo he</span> 
                        <span class="plus-sign">+</span>
                        <span class="formula-part" onclick="speak('comido')">comido</span>
                    </div>
                    <p style="font-style: italic; color:#666;" data-lang-key="viz_meaning">= I have eaten</p>
                </div>
            </div>

            <div id="tab-formation" class="main-tab-content">
                <h2 data-lang-key="form_title">How It Works</h2>
                
                <p data-lang-key="form_intro">The Present Perfect is formed by two parts: The Auxiliary Verb (Helper) and the Past Participle.</p>

                <h3>1. The Helper (Haber)</h3>
                <p data-lang-key="helper_desc">This verb changes based on <em>who</em> is doing the action. Click to listen.</p>
                <div class="haber-grid">
                    <div class="haber-box" onclick="speak('Yo he')">Yo <strong>he</strong></div>
                    <div class="haber-box" onclick="speak('T√∫ has')">T√∫ <strong>has</strong></div>
                    <div class="haber-box" onclick="speak('√âl ha')">√âl/Ella <strong>ha</strong></div>
                    <div class="haber-box" onclick="speak('Nosotros hemos')">Nosotros <strong>hemos</strong></div>
                    <div class="haber-box" onclick="speak('Vosotros hab√©is')">Vosotros <strong>hab√©is</strong></div>
                    <div class="haber-box" onclick="speak('Ellos han')">Ellos <strong>han</strong></div>
                </div>

                <h3 style="margin-top:30px;">2. The Irregulars (REVV MAC PH DD)</h3>
                <p data-lang-key="irreg_desc">Most verbs end in <em>-ado</em> or <em>-ido</em>. But these 11 verbs are special. Memorize the acronym!</p>
                <div class="acronym-container" id="acronyms">
                    </div>
            </div>

            <div id="tab-practice" class="main-tab-content">
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="quiz_title">Part 1: Conjugation Quiz</h3>
                        <button class="refresh-btn" onclick="generateQuiz()" data-lang-key="btn_new">New Questions</button>
                    </div>
                    <p data-lang-key="quiz_instr">Write the correct form of "Haber" + Participle.</p>
                    <div id="quiz-container"></div>
                </div>

                <hr style="margin: 30px 0; border-top: 1px dashed #ccc;">

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="drag_title">Part 2: Regular vs. Irregular</h3>
                        <button class="refresh-btn" onclick="generateDragDrop()" data-lang-key="btn_reset">Reset</button>
                    </div>
                    <p data-lang-key="drag_instr">Drag the participle to the correct box.</p>
                    
                    <div id="drag-pool"></div>
                    
                    <div class="sorter-container">
                        <div class="dropzone" id="zone-regular">
                            <h4>‚úÖ Regular (-ado/-ido)</h4>
                        </div>
                        <div class="dropzone" id="zone-irregular">
                            <h4>‚ö†Ô∏è Irregular (REVV MAC)</h4>
                        </div>
                    </div>
                    <button class="button-primary" onclick="checkDrag()" style="margin-top:20px; display:block; width:100%;" data-lang-key="btn_check">Check Sorting</button>
                    <div id="drag-feedback" class="feedback" style="text-align:center; margin-top:10px;"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2 data-lang-key="flash_title">Flashcards</h2>
                <div class="flashcard-container">
                    <div class="flashcard" id="flashcard">
                        <div class="card-face card-front" id="fc-front"></div>
                        <div class="card-face card-back" id="fc-back"></div>
                    </div>
                </div>
                <div class="flashcard-nav">
                    <button class="btn-fc" onclick="prevCard()" data-lang-key="btn_prev">Prev</button>
                    <button class="btn-fc flip" onclick="flipCard()" data-lang-key="btn_flip">Flip</button>
                    <button class="btn-fc" onclick="nextCard()" data-lang-key="btn_next">Next</button>
                </div>
            </div>
        </main>
    </div>

<script>
// --- UI STRINGS (Translation) ---
const uiData = {
    en: {
        header_title: "Present Perfect",
        header_subtitle: "The Bridge: Connecting Past & Present üåâ",
        tab_metaphor: "üåâ The Concept",
        tab_formation: "üß™ Formula",
        tab_practice: "üß† Interactive Practice",
        tab_flashcards: "üìá Flashcards",
        metaphor_title: "The Bridge Metaphor",
        bridge_past: "PAST ACTION",
        bridge_past_desc: "Completed action",
        bridge_link: "The Bridge",
        rule_desc: "Use <em>Haber</em> + <em>Participle</em> to connect past to present.",
        bridge_pres: "PRESENT",
        bridge_pres_desc: "Relevant now",
        video_title: "Video Tutorial",
        viz_title: "Formula Visualizer",
        viz_desc: "Click to build the structure.",
        viz_meaning: "= I have eaten",
        form_title: "How It Works",
        form_intro: "The Present Perfect is formed by two parts: The Auxiliary Verb (Helper) and the Past Participle.",
        helper_desc: "This verb changes based on <em>who</em> is doing the action. Click to listen.",
        irreg_desc: "Most verbs end in <em>-ado</em> or <em>-ido</em>. But these 11 verbs are special. Memorize the acronym!",
        quiz_title: "Part 1: Conjugation Quiz",
        btn_new: "New Questions",
        quiz_instr: "Write the correct form of \"Haber\" + Participle.",
        drag_title: "Part 2: Regular vs. Irregular",
        btn_reset: "Reset",
        drag_instr: "Drag the participle to the correct box.",
        btn_check: "Check Sorting",
        flash_title: "Flashcards",
        btn_prev: "Prev",
        btn_flip: "Flip",
        btn_next: "Next"
    },
    es: {
        header_title: "Pret√©rito Perfecto",
        header_subtitle: "El Puente: Conectando Pasado y Presente üåâ",
        tab_metaphor: "üåâ El Concepto",
        tab_formation: "üß™ F√≥rmula",
        tab_practice: "üß† Pr√°ctica Interactiva",
        tab_flashcards: "üìá Flashcards",
        metaphor_title: "La Met√°fora del Puente",
        bridge_past: "ACCI√ìN PASADA",
        bridge_past_desc: "Acci√≥n terminada",
        bridge_link: "El Puente",
        rule_desc: "Usa <em>Haber</em> + <em>Participio</em> para conectar pasado y presente.",
        bridge_pres: "PRESENTE",
        bridge_pres_desc: "Relevante ahora",
        video_title: "Video Tutorial",
        viz_title: "Visualizador de F√≥rmula",
        viz_desc: "Haz clic para construir la estructura.",
        viz_meaning: "= Yo he comido",
        form_title: "C√≥mo Funciona",
        form_intro: "El Pret√©rito Perfecto se forma con dos partes: El Verbo Auxiliar y el Participio.",
        helper_desc: "Este verbo cambia seg√∫n <em>qui√©n</em> hace la acci√≥n. Haz clic para escuchar.",
        irreg_desc: "La mayor√≠a terminan en <em>-ado</em> o <em>-ido</em>. Pero estos 11 son especiales.",
        quiz_title: "Parte 1: Quiz de Conjugaci√≥n",
        btn_new: "Nuevas Preguntas",
        quiz_instr: "Escribe la forma correcta de \"Haber\" + Participio.",
        drag_title: "Parte 2: Regular vs. Irregular",
        btn_reset: "Reiniciar",
        drag_instr: "Arrastra el participio a la caja correcta.",
        btn_check: "Verificar",
        flash_title: "Flashcards",
        btn_prev: "Ant",
        btn_flip: "Voltear",
        btn_next: "Sig"
    }
};
let currentLang = 'en';

// --- DATA ---
const irregulars = [
    {l:"R", w:"Romper", p:"Roto"}, {l:"E", w:"Escribir", p:"Escrito"}, {l:"V", w:"Ver", p:"Visto"}, 
    {l:"V", w:"Volver", p:"Vuelto"}, {l:"M", w:"Morir", p:"Muerto"}, {l:"A", w:"Abrir", p:"Abierto"}, 
    {l:"C", w:"Cubrir", p:"Cubierto"}, {l:"P", w:"Poner", p:"Puesto"}, {l:"H", w:"Hacer", p:"Hecho"}, 
    {l:"D", w:"Decir", p:"Dicho"}, {l:"D", w:"Devolver", p:"Devuelto"}
];

// 30 Questions for Quiz
const quizBank = [
    {q: "Yo (hablar)", a: "he hablado"}, {q: "T√∫ (comer)", a: "has comido"}, {q: "Ella (vivir)", a: "ha vivido"},
    {q: "Nosotros (trabajar)", a: "hemos trabajado"}, {q: "Ellos (beber)", a: "han bebido"}, {q: "Vosotros (estudiar)", a: "hab√©is estudiado"},
    {q: "Yo (escribir)", a: "he escrito"}, {q: "T√∫ (ver)", a: "has visto"}, {q: "√âl (romper)", a: "ha roto"},
    {q: "Nosotros (volver)", a: "hemos vuelto"}, {q: "Ellas (morir)", a: "han muerto"}, {q: "Yo (abrir)", a: "he abierto"},
    {q: "T√∫ (poner)", a: "has puesto"}, {q: "Usted (hacer)", a: "ha hecho"}, {q: "Nosotros (decir)", a: "hemos dicho"},
    {q: "Ellos (cubrir)", a: "han cubierto"}, {q: "Yo (devolver)", a: "he devuelto"}, {q: "T√∫ (viajar)", a: "has viajado"},
    {q: "Ella (leer)", a: "ha le√≠do"}, {q: "Nosotros (o√≠r)", a: "hemos o√≠do"},
    {q: "Ellos (imprimir)", a: "han impreso"}, {q: "Yo (descubrir)", a: "he descubierto"}, {q: "T√∫ (cantar)", a: "has cantado"},
    {q: "Ella (correr)", a: "ha corrido"}, {q: "Nosotros (salir)", a: "hemos salido"}, {q: "Vosotros (jugar)", a: "hab√©is jugado"},
    {q: "Ustedes (dormir)", a: "han dormido"}, {q: "Yo (limpiar)", a: "he limpiado"}, {q: "T√∫ (cocinar)", a: "has cocinado"},
    {q: "√âl (caminar)", a: "ha caminado"}
];

// 24 Drag Items
const dragBank = [
    {w: "Hablado", t: "regular"}, {w: "Comido", t: "regular"}, {w: "Vivido", t: "regular"}, {w: "Bailado", t: "regular"},
    {w: "Estudiado", t: "regular"}, {w: "Corrido", t: "regular"}, {w: "Dormido", t: "regular"}, {w: "Jugado", t: "regular"},
    {w: "Cantado", t: "regular"}, {w: "Bebido", t: "regular"}, {w: "Salido", t: "regular"}, {w: "Viajado", t: "regular"},
    {w: "Hecho", t: "irregular"}, {w: "Roto", t: "irregular"}, {w: "Visto", t: "irregular"}, {w: "Escrito", t: "irregular"},
    {w: "Muerto", t: "irregular"}, {w: "Abierto", t: "irregular"}, {w: "Puesto", t: "irregular"}, {w: "Dicho", t: "irregular"},
    {w: "Vuelto", t: "irregular"}, {w: "Cubierto", t: "irregular"}, {w: "Devuelto", t: "irregular"}, {w: "Descubierto", t: "irregular"}
];

const flashcards = [
    {en:"I have spoken", es:"Yo he hablado", expl: "Haber (Yo) + Regular AR (-ado)"},
    {en:"You have eaten", es:"T√∫ has comido", expl: "Haber (T√∫) + Regular ER (-ido)"},
    {en:"She has lived", es:"Ella ha vivido", expl: "Haber (Ella) + Regular IR (-ido)"},
    {en:"We have done (Irreg)", es:"Nosotros hemos hecho", expl: "Irregular: Hacer -> Hecho"},
    {en:"They have seen (Irreg)", es:"Ellos han visto", expl: "Irregular: Ver -> Visto"},
    {en:"I have written (Irreg)", es:"Yo he escrito", expl: "Irregular: Escribir -> Escrito"},
    {en:"You have broken (Irreg)", es:"T√∫ has roto", expl: "Irregular: Romper -> Roto"},
    {en:"He has put (Irreg)", es:"√âl ha puesto", expl: "Irregular: Poner -> Puesto"},
    {en:"We have said (Irreg)", es:"Hemos dicho", expl: "Irregular: Decir -> Dicho"},
    {en:"They have returned (Irreg)", es:"Han vuelto", expl: "Irregular: Volver -> Vuelto"},
    {en:"I have opened (Irreg)", es:"He abierto", expl: "Irregular: Abrir -> Abierto"},
    {en:"You have died (Irreg)", es:"Has muerto", expl: "Irregular: Morir -> Muerto"}
];

// --- LOGIC ---

document.addEventListener('DOMContentLoaded', () => {
    // Init Tabs
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        
        // Lazy load practice
        if (tabId === 'tab-practice' && !document.getElementById('quiz-container').hasChildNodes()) {
            generateQuiz(); generateDragDrop();
        }
    }

    // Init Acronyms
    const acBox = document.getElementById('acronyms');
    irregulars.forEach(i => {
        acBox.innerHTML += `
            <div class="acronym-card" onclick="this.classList.toggle('flipped'); speak('${i.w}... ${i.p}')">
                <div class="acronym-inner">
                    <div class="acronym-front">${i.l}</div>
                    <div class="acronym-back">${i.w}<br>‚¨áÔ∏è<br><strong>${i.p}</strong></div>
                </div>
            </div>`;
    });

    // Init Flashcards
    loadCard();
});

// 1. QUIZ LOGIC
function generateQuiz() {
    const container = document.getElementById('quiz-container');
    container.innerHTML = '';
    const qs = [...quizBank].sort(()=>0.5-Math.random()).slice(0,5); // 5 Random questions
    
    qs.forEach((q, idx) => {
        // CORRECCION: Limpiar par√©ntesis para el audio
        const audioText = q.q.replace(/[()]/g, "");
        container.innerHTML += `
            <div class="quiz-question">
                <p>${idx+1}. ${q.q} <span class="tts-icon" onclick="speak('${audioText}')">üîä</span></p>
                <input type="text" id="inp-${idx}" placeholder="Ex: he comido">
                <button onclick="checkQ(${idx}, '${q.a}')">Check</button>
                <span id="fb-${idx}" class="feedback"></span>
            </div>`;
    });
}

window.checkQ = function(idx, ans) {
    const inp = document.getElementById(`inp-${idx}`);
    const fb = document.getElementById(`fb-${idx}`);
    if(inp.value.toLowerCase().trim() === ans.toLowerCase()) {
        fb.textContent = "Correct! ‚úÖ"; fb.className = "feedback correct";
    } else {
        fb.textContent = `Incorrect. It is: ${ans} ‚ùå`; fb.className = "feedback incorrect";
    }
}

// 2. DRAG & DROP LOGIC
const dragPool = document.getElementById('drag-pool');
let currentDragItems = [];

function generateDragDrop() {
    dragPool.innerHTML = '';
    document.getElementById('drag-feedback').textContent = '';
    document.querySelectorAll('.dropzone .draggable').forEach(e=>e.remove());
    
    currentDragItems = [...dragBank].sort(()=>0.5-Math.random()).slice(0,8); // 8 Random items
    
    currentDragItems.forEach(i => {
        const el = document.createElement('div');
        el.className = 'draggable'; el.draggable = true;
        el.innerHTML = `${i.w} <span class="tts-icon" onclick="event.stopPropagation(); speak('${i.w}')">üîä</span>`;
        el.dataset.type = i.t; // regular or irregular
        
        el.addEventListener('dragstart', e => { e.dataTransfer.setData('text', i.t); e.target.classList.add('dragging'); });
        el.addEventListener('dragend', e => e.target.classList.remove('dragging'));
        el.addEventListener('touchstart', touchStart, {passive: false});
        
        dragPool.appendChild(el);
    });
    
    setupDropzones();
}

function setupDropzones() {
    document.querySelectorAll('.dropzone').forEach(z => {
        z.addEventListener('dragover', e => e.preventDefault());
        z.addEventListener('drop', e => {
            e.preventDefault();
            const dragging = document.querySelector('.dragging');
            if(dragging) z.appendChild(dragging);
        });
    });
}

window.checkDrag = function() {
    let correct = 0;
    const regZone = document.getElementById('zone-regular');
    const irregZone = document.getElementById('zone-irregular');
    
    const checkZone = (zone, type) => {
        zone.querySelectorAll('.draggable').forEach(d => {
            if(d.dataset.type === type) {
                d.style.background = "#d4edda"; correct++;
            } else {
                d.style.background = "#f8d7da";
            }
        });
    };
    
    checkZone(regZone, 'regular');
    checkZone(irregZone, 'irregular');
    
    const total = regZone.querySelectorAll('.draggable').length + irregZone.querySelectorAll('.draggable').length;
    document.getElementById('drag-feedback').textContent = total > 0 ? `Score: ${correct} / ${total}` : "Drag items first!";
}

// Touch Logic (iPad)
let tDrag = null;
function touchStart(e) {
    if(e.target.classList.contains('tts-icon')) return;
    tDrag = e.target.closest('.draggable');
    if(!tDrag) return;
    // e.preventDefault(); 
    setTimeout(() => tDrag.classList.add('dragging'), 100);
    document.addEventListener('touchmove', touchMove, {passive:false});
    document.addEventListener('touchend', touchEnd);
}
function touchMove(e) {
    if(!tDrag) return;
    e.preventDefault();
    const t = e.touches[0];
    tDrag.style.position = 'fixed'; tDrag.style.zIndex = 1000;
    tDrag.style.left = (t.clientX - tDrag.offsetWidth/2) + 'px';
    tDrag.style.top = (t.clientY - tDrag.offsetHeight/2) + 'px';
}
function touchEnd(e) {
    if(!tDrag) return;
    const t = e.changedTouches[0];
    tDrag.style.position = ''; tDrag.style.zIndex = ''; tDrag.style.left = ''; tDrag.style.top = '';
    tDrag.classList.remove('dragging');
    
    const elem = document.elementFromPoint(t.clientX, t.clientY);
    const zone = elem ? elem.closest('.dropzone') : null;
    if(zone) zone.appendChild(tDrag);
    
    document.removeEventListener('touchmove', touchMove);
    document.removeEventListener('touchend', touchEnd);
    tDrag = null;
}

// 3. FLASHCARDS LOGIC
let cIdx = 0;
function loadCard() {
    const d = flashcards[cIdx];
    // Clean audio text
    const audioText = d.es.replace(/<[^>]*>?/gm, '');
    const tts = `&nbsp;<span class="tts-icon" data-tts="${audioText}">üîä</span>`;
    document.getElementById('fc-front').innerHTML = d.en;
    document.getElementById('fc-back').innerHTML = `${d.es}${tts}<br><br><small style="color:var(--dark-blue)">${d.expl}</small>`;
    document.getElementById('flashcard').classList.remove('is-flipped');
}
window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
window.nextCard = () => { cIdx=(cIdx+1)%flashcards.length; loadCard(); };
window.prevCard = () => { cIdx=(cIdx-1+flashcards.length)%flashcards.length; loadCard(); };

// Audio Click Handler
document.body.addEventListener('click', function(e) {
    if(e.target.classList.contains('tts-icon')) {
        e.stopPropagation(); // Stop flip
        speak(e.target.dataset.tts);
    } else if(e.target.closest('#flashcard')) {
        flipCard();
    }
});

// UI Functions
window.toggleLang = function() {
    currentLang = currentLang === 'en' ? 'es' : 'en';
    document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.dataset.langKey;
        if(uiData[currentLang][key]) el.innerHTML = uiData[currentLang][key];
    });
}

window.toggleTheme = () => document.body.classList.toggle('dark-mode');

// AUDIO ENGINE (PREMIUM VOICE SEEKER)
function speak(txt) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = 'es-ES';
    
    // Smart Voice Selection Strategy
    const voices = window.speechSynthesis.getVoices();
    let v = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('es')); // Chrome
    if (!v) v = voices.find(voice => (voice.name.includes('Monica') || voice.name.includes('Paulina')) && voice.lang.includes('es')); // Windows/Mac
    if (!v) v = voices.find(voice => voice.lang.includes('es')); // Fallback
    
    if(v) u.voice = v;
    window.speechSynthesis.speak(u);
}

// Init
window.speechSynthesis.onvoiceschanged = () => {}; // Force load voices
loadCard();
</script>
</body>
</html>
