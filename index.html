<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Present Perfect Master</title>
    
    <style>
        :root {
            /* Paleta Azul Est√°ndar */
            --primary: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #ffc107;
            
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1e1e1e;
            --tab-bg: #333;
            --tab-active-bg: var(--primary);
            --tab-text: #bbb;
            --tab-active-text: #ffffff;
            --border-color: #444;
            --light-gray-bg: #2a2a20;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            overflow: hidden;
            transition: background-color 0.3s;
        }
        header {
            background: var(--header-bg);
            color: white;
            padding: 25px 35px;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0; font-size: 2.5em; }
        header p { font-size: 1.2em; opacity: 0.9; margin: 5px 0 0; }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .control-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }
        .control-button:hover { background: rgba(255,255,255,0.4); }

        /* Pesta√±as */
        .main-tab-nav {
            display: flex;
            background-color: var(--tab-bg);
            border-bottom: 3px solid var(--dark-blue);
        }
        .main-tab-nav button {
            background-color: inherit; border: none; outline: none; cursor: pointer;
            padding: 18px 25px; transition: 0.3s; font-size: 1.1em;
            font-weight: bold; color: var(--tab-text); flex-grow: 1;
        }
        .main-tab-nav button:hover { background-color: var(--border-color); }
        .main-tab-nav button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos Generales */
        h2 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px; font-size: 1.8em; margin-top: 0; }
        h3 { color: var(--green); font-size: 1.4em; margin-top: 25px; }
        .accent { color: var(--primary); font-weight: bold; }
        
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;}
        
        /* Bridge Visual */
        .bridge-visual {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--light-gray-bg);
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed var(--border-color);
            margin-bottom: 20px;
        }
        .bridge-step { flex: 1; text-align: center; }
        .bridge-arrow { font-size: 2.5em; color: var(--primary); font-weight: bold; display: block;}
        .bridge-icon { font-size: 3.5em; display: block; margin-bottom: 10px; }
        .rule-box { background: #e3f2fd; border: 1px solid #90caf9; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: left;}
        body.dark-mode .rule-box { background: #1e2a36; border-color: #444; }

        /* Video */
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; background: #000; margin-top: 20px; border: 1px solid var(--border-color); }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        /* Visualizer */
        .formula-visualizer { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px; }
        .formula-part { padding: 8px 12px; border-radius: 5px; background-color: var(--container-bg); border: 1px solid var(--border-color); margin: 0 5px; display: inline-block; font-size: 1.2em; font-weight: bold; }
        .plus-sign { font-weight: bold; color: var(--primary); font-size: 1.2em; }

        /* The Helper Grid */
        .haber-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .haber-box { background: var(--primary); color: white; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s; font-weight: bold; font-size: 1.2em; }
        .haber-box:hover { transform: translateY(-3px); background: var(--dark-blue); }

        /* Irregulars */
        .acronym-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
        .acronym-card { width: 100px; height: 100px; perspective: 1000px; cursor: pointer; }
        .acronym-inner { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .acronym-card.flipped .acronym-inner { transform: rotateY(180deg); }
        .acronym-front, .acronym-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .acronym-front { background: var(--yellow); color: #333; font-size: 2em; font-weight: bold; border: 2px solid #e0a800; }
        .acronym-back { background: var(--dark-blue); color: white; transform: rotateY(180deg); font-size: 0.85em; text-align: center; padding: 2px; }

        /* Practice */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background-color: var(--primary); color: white; border:none; border-radius: 4px; cursor: pointer;}
        .quiz-question { margin-bottom: 15px; background: var(--light-gray-bg); padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary); }
        .quiz-question input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; width: 180px; }
        .quiz-question button { background-color: var(--green); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }

        /* Drag Drop */
        .dropzone { flex: 1; min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; }
        .draggable { display: inline-block; background: var(--container-bg); border: 1px solid #ccc; padding: 8px 12px; margin: 5px; border-radius: 20px; cursor: grab; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .draggable.dragging { opacity: 0.5; border: 2px dashed var(--primary); }

        /* Flashcards (Restaurado) */
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin: 0 auto 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; font-size: 1.4em; border-radius: 10px; box-sizing: border-box; white-space: normal; word-break: break-word; }
        .card-front { background: var(--container-bg); border: 2px solid var(--primary); color: var(--text-color); }
        .card-back { background: var(--light-gray-bg); border: 2px solid var(--green); color: var(--dark-blue); transform: rotateY(180deg); }
        .flashcard-nav { text-align: center; }
        .btn-fc { background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; margin: 0 5px; }
        .btn-fc.flip { background-color: var(--primary); }
        .card-back small { color: #555; }

        .tts-icon { font-size: 1.1em; cursor: pointer; margin-left: 8px; transition: transform 0.2s; }
        .tts-icon:hover { transform: scale(1.2); }

        /* Interactive Story Specific Styles (mantenido) */
        .interactive-story {
            font-size: 1.2em;
            line-height: 2;
            padding: 20px;
            background: #fdfaf6; 
            border: 1px solid var(--yellow); 
            border-radius: 8px; 
            color: #333; 
        }
        .interactive-story select { 
            font-size: 1em; 
            border: 2px solid #ccc; 
            border-radius: 4px; 
            background: #fff; 
            padding: 2px 5px; 
        }
        .story-explanation { 
            display: inline-block; 
            font-size: 0.9em; 
            font-style: italic; 
            color: var(--dark-blue); 
            margin-left: 10px; 
        }
        body.dark-mode .interactive-story { color: #333; }
        body.dark-mode .story-explanation { color: #80bfff; }
    </style>
</head>
<body class="">

    <div class="container">
        <header>
            <div class="header-controls">
                <button class="control-button" onclick="toggleLang()">EN / ES</button>
                <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
            </div>
            <h1 data-lang-key="header_title">Present Perfect</h1>
            <p data-lang-key="header_subtitle">The Bridge: Connecting Past & Present</p>
        </header>
        
        <nav class="main-tab-nav">
            <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')" data-lang-key="tab_metaphor">üåâ The Concept</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-formation')" data-lang-key="tab_formation">‚úçÔ∏è Formula</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practice')" data-lang-key="tab_practice">üß† Interactive Practice</button>
            <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')" data-lang-key="tab_flashcards">üìá Flashcards</button>
        </nav>

        <main>
            <div id="tab-metaphor" class="main-tab-content is-active">
                <h2 data-lang-key="metaphor_title">The Bridge Metaphor</h2>
                
                <div class="bridge-visual">
                    <div class="bridge-step">
                        <span class="bridge-icon">‚è™</span>
                        <strong data-lang-key="bridge_past">PAST</strong><br>
                        <small data-lang-key="bridge_past_desc">Completed action</small>
                    </div>
                    <div class="bridge-step" style="flex: 2;">
                        <span class="bridge-icon">üåâ</span>
                        <strong data-lang-key="bridge_link">The Bridge</strong><br>
                        <div class="rule-box">
                            <strong>Rule:</strong> <span data-lang-key="rule_desc">Usa <em>Haber</em> + <em>Participio</em> to connect the past to the present.</span>
                        </div>
                    </div>
                    <div class="bridge-step">
                        <span class="bridge-icon">üëá</span>
                        <strong data-lang-key="bridge_pres">PRESENT</strong><br>
                        <small data-lang-key="bridge_pres_desc">Relevant now</small>
                    </div>
                </div>

                <h3 data-lang-key="video_title">Video Tutorial</h3>
                <div class="video-container">
                    <iframe src="https://drive.google.com/file/d/1Ez-tCYUf3rnTImlgoRKYdsewhWE9iOzN/preview" allow="autoplay"></iframe>
                </div>

                <h3 style="margin-top:30px;" data-lang-key="viz_title">Formula Visualizer</h3>
                <div class="formula-visualizer">
                    <p data-lang-key="viz_desc">Click to build the structure.</p>
                    <div style="font-size: 2em; margin-bottom: 15px;">
                        <span class="formula-part" onclick="speak('Yo he')">Yo he</span> 
                        <span class="plus-sign">+</span>
                        <span class="formula-part" onclick="speak('comido')">comido</span>
                    </div>
                    <p style="font-style: italic; color:#666;" data-lang-key="viz_meaning">= I have eaten</p>
                </div>
            </div>

            <div id="tab-formation" class="main-tab-content">
                <h2 data-lang-key="form_title">How It Works</h2>
                
                <p data-lang-key="form_intro">The Present Perfect is formed by two parts: The Auxiliary Verb (Helper) and the Past Participle.</p>

                <h3>1. The Helper (Haber)</h3>
                <p data-lang-key="helper_desc">This verb changes based on <em>who</em> is doing the action. Click to listen.</p>
                <div class="haber-grid">
                    <div class="haber-box" onclick="speak('Yo he')">Yo <strong>he</strong></div>
                    <div class="haber-box" onclick="speak('T√∫ has')">T√∫ <strong>has</strong></div>
                    <div class="haber-box" onclick="speak('√âl ha')">√âl/Ella <strong>ha</strong></div>
                    <div class="haber-box" onclick="speak('Nosotros hemos')">Nosotros <strong>hemos</strong></div>
                    <div class="haber-box" onclick="speak('Vosotros hab√©is')">Vosotros <strong>hab√©is</strong></div>
                    <div class="haber-box" onclick="speak('Ellos han')">Ellos <strong>han</strong></div>
                </div>

                <h3 style="margin-top:30px;">2. The Irregulars (REVV MAC PH DD)</h3>
                <p data-lang-key="irreg_desc">Most verbs end in <em>-ado</em> or <em>-ido</em>. But these 11 verbs are special. Memorize the acronym!</p>
                <div class="acronym-container" id="acronyms">
                    </div>
            </div>

            <div id="tab-practice" class="main-tab-content">
                
                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="quiz_title">Part 1: Conjugation Quiz</h3>
                        <button class="refresh-btn" onclick="generateQuiz()" data-lang-key="btn_new">New Questions</button>
                    </div>
                    <p data-lang-key="quiz_instr">Write the correct form of "Haber" + Participle.</p>
                    <div id="quiz-container"></div>
                </div>

                <hr style="margin: 30px 0; border-top: 1px dashed #ccc;">

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="story_title">Part 2: Interactive Story</h3> 
                        <button id="generate-story" class="refresh-btn" onclick="generateStory()" data-lang-key="btn_new">New Story</button>
                    </div>
                    <p data-lang-key="story_instr">Select the correct verb form (Haber + Participle).</p> 
                    <div id="story-container" class="interactive-story"></div>
                    <button id="check-story-btn" class="button-primary" style="margin-top: 20px;" onclick="checkStory()">Check Story</button>
                </div>
                <hr style="margin: 30px 0; border-top: 1px dashed #ccc;">

                <div class="quiz-section">
                    <div class="section-header">
                        <h3 data-lang-key="drag_title">Part 3: Regular vs. Irregular</h3>
                        <button class="refresh-btn" onclick="generateDragDrop()" data-lang-key="btn_reset">Reset</button>
                    </div>
                    <p data-lang-key="drag_instr">Drag the participle to the correct box.</p>
                    
                    <div id="drag-pool" style="background:#eee; padding:10px; border-radius:8px; min-height:50px; margin-bottom:10px;"></div>
                    
                    <div class="sorter-area" style="display:flex; gap:20px;">
                        <div class="dropzone" id="zone-regular" style="flex:1;">
                            <h4>‚úÖ Regular (-ado/-ido)</h4>
                        </div>
                        <div class="dropzone" id="zone-irregular" style="flex:1;">
                            <h4>‚ö†Ô∏è Irregular (REVV MAC)</h4>
                        </div>
                    </div>
                    <button class="button-primary" onclick="checkDrag()" style="margin-top:20px; display:block; width:100%;" data-lang-key="btn_check">Check Sorting</button>
                    <div id="drag-feedback" class="feedback" style="text-align:center; margin-top:10px;"></div>
                </div>
            </div>

            <div id="tab-flashcards" class="main-tab-content">
                <h2 data-lang-key="flash_title">Flashcards</h2>
                <div class="flashcard-app">
                    <div class="flashcard-container">
                        <div class="flashcard" id="flashcard">
                            <div class="card-face card-front" id="fc-front"></div>
                            <div class="card-face card-back" id="fc-back"></div>
                        </div>
                    </div>
                    <div class="flashcard-nav">
                        <button class="btn-fc" onclick="prevCard()" data-lang-key="btn_prev">Prev</button>
                        <button class="btn-fc flip" onclick="flipCard()" data-lang-key="btn_flip">Flip</button>
                        <button class="btn-fc" onclick="nextCard()" data-lang-key="btn_next">Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
// --- UI STRINGS (Translation) ---
const uiData = {
    en: {
        header_title: "Present Perfect",
        header_subtitle: "The Bridge: Connecting Past & Present üåâ",
        tab_metaphor: "üåâ The Concept",
        tab_formation: "üß™ Formula",
        tab_practice: "üß† Interactive Practice",
        tab_flashcards: "üìá Flashcards",
        metaphor_title: "The Bridge Metaphor",
        bridge_past: "PAST ACTION",
        bridge_past_desc: "Completed action",
        bridge_link: "The Bridge",
        rule_desc: "Use <em>Haber</em> + <em>Participle</em> to connect past to present.",
        bridge_pres: "PRESENT",
        bridge_pres_desc: "Relevant now",
        video_title: "Video Tutorial",
        viz_title: "Formula Visualizer",
        viz_desc: "Click to build the structure.",
        viz_meaning: "= I have eaten",
        form_title: "How It Works",
        form_intro: "The Present Perfect is formed by two parts: The Auxiliary Verb (Helper) and the Past Participle.",
        helper_desc: "This verb changes based on <em>who</em> is doing the action. Click to listen.",
        irreg_desc: "Most verbs end in <em>-ado</em> or <em>-ido</em>. But these 11 verbs are special. Memorize the acronym!",
        quiz_title: "Part 1: Conjugation Quiz",
        btn_new: "New Questions",
        quiz_instr: "Write the correct form of \"Haber\" + Participle.",
        story_title: "Part 2: Interactive Story", // NUEVO
        story_instr: "Select the correct verb form (Haber + Participle).", // NUEVO
        drag_title: "Part 3: Regular vs. Irregular", // ACTUALIZADO
        btn_reset: "Reset",
        drag_instr: "Drag the participle to the correct box.",
        btn_check: "Check Sorting",
        flash_title: "Flashcards",
        btn_prev: "Prev",
        btn_flip: "Flip",
        btn_next: "Next"
    },
    es: {
        header_title: "Pret√©rito Perfecto",
        header_subtitle: "El Puente: Conectando Pasado y Presente üåâ",
        tab_metaphor: "üåâ El Concepto",
        tab_formation: "üß™ F√≥rmula",
        tab_practice: "üß† Pr√°ctica Interactiva",
        tab_flashcards: "üìá Flashcards",
        metaphor_title: "La Met√°fora del Puente",
        bridge_past: "ACCI√ìN PASADA",
        bridge_past_desc: "Acci√≥n terminada",
        bridge_link: "El Puente",
        rule_desc: "Usa <em>Haber</em> + <em>Participio</em> para conectar pasado y presente.",
        bridge_pres: "PRESENTE",
        bridge_pres_desc: "Relevante ahora",
        video_title: "Video Tutorial",
        viz_title: "Visualizador de F√≥rmula",
        viz_desc: "Haz clic para construir la estructura.",
        viz_meaning: "= Yo he comido",
        form_title: "C√≥mo Funciona",
        form_intro: "El Pret√©rito Perfecto se forma con dos partes: El Verbo Auxiliar y el Participio.",
        helper_desc: "Este verbo cambia seg√∫n <em>qui√©n</em> hace la acci√≥n. Haz clic para escuchar.",
        irreg_desc: "La mayor√≠a terminan en <em>-ado</em> o <em>-ido</em>. Pero estos 11 son especiales.",
        quiz_title: "Parte 1: Quiz de Conjugaci√≥n",
        btn_new: "Nuevas Preguntas",
        quiz_instr: "Escribe la forma correcta de \"Haber\" + Participio.",
        story_title: "Parte 2: Historia Interactiva", // NUEVO
        story_instr: "Selecciona la forma verbal correcta (Haber + Participio).", // NUEVO
        drag_title: "Parte 3: Regular vs. Irregular", // ACTUALIZADO
        btn_reset: "Reiniciar",
        drag_instr: "Arrastra el participio a la caja correcta.",
        btn_check: "Verificar",
        flash_title: "Fichas",
        btn_prev: "Ant",
        btn_flip: "Voltear",
        btn_next: "Sig"
    }
};
let currentLang = 'en';

// --- DATA ---
const irregulars = [
    {l:"R", w:"Romper", p:"Roto"}, {l:"E", w:"Escribir", p:"Escrito"}, {l:"V", w:"Ver", p:"Visto"}, 
    {l:"V", w:"Volver", p:"Vuelto"}, {l:"M", w:"Morir", p:"Muerto"}, {l:"A", w:"Abrir", p:"Abierto"}, 
    {l:"C", w:"Cubrir", p:"Cubierto"}, {l:"P", w:"Poner", p:"Puesto"}, {l:"H", w:"Hacer", p:"Hecho"}, 
    {l:"D", w:"Decir", p:"Dicho"}, {l:"D", w:"Devolver", p:"Devuelto"}
];

// 30 Questions for Quiz (Original bank structure preserved)
const quizBank = [
    {q: "Yo (hablar)", a: "he hablado"}, {q: "T√∫ (comer)", a: "has comido"}, {q: "Ella (vivir)", a: "ha vivido"},
    {q: "Nosotros (trabajar)", a: "hemos trabajado"}, {q: "Ellos (beber)", a: "han bebido"}, {q: "Vosotros (estudiar)", a: "hab√©is estudiado"},
    {q: "Yo (escribir)", a: "he escrito"}, {q: "T√∫ (ver)", a: "has visto"}, {q: "√âl (romper)", a: "ha roto"},
    {q: "Nosotros (volver)", a: "hemos vuelto"}, {q: "Ellas (morir)", a: "han muerto"}, {q: "Yo (abrir)", a: "he abierto"},
    {q: "T√∫ (poner)", a: "has puesto"}, {q: "Usted (hacer)", a: "ha hecho"}, {q: "Nosotros (decir)", a: "hemos dicho"},
    {q: "Ellos (cubrir)", a: "han cubierto"}, {q: "Yo (devolver)", a: "he devuelto"}, {q: "T√∫ (viajar)", a: "has viajado"},
    {q: "Ella (leer)", a: "ha le√≠do"}, {q: "Nosotros (o√≠r)", a: "hemos o√≠do"},
    {q: "Ellos (imprimir)", a: "han impreso"}, {q: "Yo (descubrir)", a: "he descubierto"}, {q: "T√∫ (cantar)", a: "has cantado"},
    {q: "Ella (correr)", a: "ha corrido"}, {q: "Nosotros (salir)", a: "hemos salido"}, {q: "Vosotros (jugar)", a: "hab√©is jugado"},
    {q: "Ustedes (dormir)", a: "han dormido"}, {q: "Yo (limpiar)", a: "he limpiado"}, {q: "T√∫ (cocinar)", a: "has cocinado"},
    {q: "√âl (caminar)", a: "ha caminado"}
];

// 24 Drag Items (Original bank structure preserved)
const dragBank = [
    {w: "Hablado", t: "regular"}, {w: "Comido", t: "regular"}, {w: "Vivido", t: "regular"}, {w: "Bailado", t: "regular"},
    {w: "Estudiado", t: "regular"}, {w: "Corrido", t: "regular"}, {w: "Dormido", t: "regular"}, {w: "Jugado", t: "regular"},
    {w: "Cantado", t: "regular"}, {w: "Bebido", t: "regular"}, {w: "Salido", t: "regular"}, {w: "Viajado", t: "regular"},
    {w: "Hecho", t: "irregular"}, {w: "Roto", t: "irregular"}, {w: "Visto", t: "irregular"}, {w: "Escrito", t: "irregular"},
    {w: "Muerto", t: "irregular"}, {w: "Abierto", t: "irregular"}, {w: "Puesto", t: "irregular"}, {w: "Dicho", t: "irregular"},
    {w: "Vuelto", t: "irregular"}, {w: "Cubierto", t: "irregular"}, {w: "Devuelto", t: "irregular"}, {w: "Descubierto", t: "irregular"}
];

// Flashcards (RESTAURADO)
const flashcards = [
    {en:"I have spoken", es:"Yo he hablado", expl: "Haber (Yo) + Regular AR (-ado)"},
    {en:"You have eaten", es:"T√∫ has comido", expl: "Haber (T√∫) + Regular ER (-ido)"},
    {en:"She has lived", es:"Ella ha vivido", expl: "Haber (Ella) + Regular IR (-ido)"},
    {en:"We have done (Irreg)", es:"Nosotros hemos hecho", expl: "Irregular: Hacer -> Hecho"},
    {en:"They have seen (Irreg)", es:"Ellos han visto", expl: "Irregular: Ver -> Visto"},
    {en:"I have written (Irreg)", es:"Yo he escrito", expl: "Irregular: Escribir -> Escrito"},
    {en:"You have broken (Irreg)", es:"T√∫ has roto", expl: "Irregular: Romper -> Roto"},
    {en:"He has put (Irreg)", es:"√âl ha puesto", expl: "Irregular: Poner -> Puesto"},
    {en:"We have said (Irreg)", es:"Hemos dicho", expl: "Irregular: Decir -> Dicho"},
    {en:"They have returned (Irreg)", es:"Han vuelto", expl: "Irregular: Volver -> Vuelto"},
    {en:"I have opened (Irreg)", es:"He abierto", expl: "Irregular: Abrir -> Abierto"},
    {en:"You have died (Irreg)", es:"Has muerto", expl: "Irregular: Morir -> Muerto"}
];

// Banco de Historias Interactivas (20 √≠tems) - NUEVO
const storyBank = [
    {
        id: "s1",
        html: `<span>Yo nunca</span> 
            <select id="story1-1" data-type="irregular"><option value="w">he ve√≠do</option><option value="c">he visto</option></select>
            <span>una aurora boreal. Pero mi amigo Juan</span> 
            <select id="story1-2" data-type="regular"><option value="c">ha viajado</option><option value="w">ha viaj√≥</option></select>
            <span>a Alaska y me dice que son incre√≠bles.`
    },
    {
        id: "s2",
        html: `<span>Nosotros</span> 
            <select id="story2-1" data-type="regular"><option value="w">hemos estudimos</option><option value="c">hemos estudiado</option></select>
            <span>mucho para el examen. La profesora</span> 
            <select id="story2-2" data-type="irregular"><option value="c">ha dicho</option><option value="w">ha dicido</option></select>
            <span>que es el m√°s dif√≠cil del semestre.`
    },
    {
        id: "s3",
        html: `<span>Ellos ya</span> 
            <select id="story3-1" data-type="irregular"><option value="w">han volvido</option><option value="c">han vuelto</option></select>
            <span>de vacaciones. ¬øQu√©</span> 
            <select id="story3-2" data-type="irregular"><option value="w">has hacido</option><option value="c">has hecho</option></select>
            <span>t√∫ este fin de semana?`
    },
    {
        id: "s4",
        html: `<span>Mi hermano</span> 
            <select id="story4-1" data-type="irregular"><option value="c">ha roto</option><option value="w">ha rompido</option></select>
            <span>su tel√©fono otra vez. Por suerte, yo le</span> 
            <select id="story4-2" data-type="regular"><option value="w">he presto</option><option value="c">he prestado</option></select>
            <span>el m√≠o.`
    },
    {
        id: "s5",
        html: `<span>¬øPor qu√© no</span> 
            <select id="story5-1" data-type="regular"><option value="c">has comido</option><option value="w">has come</option></select>
            <span>nada? Yo</span> 
            <select id="story5-2" data-type="irregular"><option value="w">he ponido</option><option value="c">he puesto</option></select>
            <span>la mesa con mi mejor vajilla para ti.`
    },
    {
        id: "s6",
        html: `<span>Usted ya</span> 
            <select id="story6-1" data-type="regular"><option value="w">ha hablar</option><option value="c">ha hablado</option></select>
            <span>con el jefe. Ahora, nosotros</span> 
            <select id="story6-2" data-type="regular"><option value="c">hemos tomado</option><option value="w">hemos tomimos</option></select>
            <span>una decisi√≥n.`
    },
    {
        id: "s7",
        html: `<span>¬øQui√©n</span> 
            <select id="story7-1" data-type="irregular"><option value="w">ha escribido</option><option value="c">ha escrito</option></select>
            <span>este poema? El autor</span> 
            <select id="story7-2" data-type="irregular"><option value="c">ha abierto</option><option value="w">ha abrido</option></select>
            <span>su coraz√≥n.`
    },
    {
        id: "s8",
        html: `<span>Mis abuelos</span> 
            <select id="story8-1" data-type="irregular"><option value="w">han morido</option><option value="c">han muerto</option></select>
            <span>hace poco. Yo nunca</span> 
            <select id="story8-2" data-type="regular"><option value="c">he vivido</option><option value="w">he viv√≠</option></select>
            <span>un dolor tan grande.`
    },
    {
        id: "s9",
        html: `<span>Nunca</span> 
            <select id="story9-1" data-type="regular"><option value="c">he dormido</option><option value="w">he duermo</option></select>
            <span>tan bien. Los vecinos no</span> 
            <select id="story9-2" data-type="irregular"><option value="c">han dicho</option><option value="w">han dicido</option></select>
            <span>nada sobre la fiesta.`
    },
    {
        id: "s10",
        html: `<span>La polic√≠a</span> 
            <select id="story10-1" data-type="irregular"><option value="w">ha cubrido</option><option value="c">ha cubierto</option></select>
            <span>la zona. Yo</span> 
            <select id="story10-2" data-type="irregular"><option value="c">he visto</option><option value="w">he veado</option></select>
            <span>el accidente.`
    },
    {
        id: "s11",
        html: `<span>¬øT√∫</span> 
            <select id="story11-1" data-type="regular"><option value="w">has le√≠</option><option value="c">has le√≠do</option></select>
            <span>el libro? El autor</span> 
            <select id="story11-2" data-type="regular"><option value="c">ha sido</option><option value="w">ha sidido</option></select>
            <span>galardonado esta semana.`
    },
    {
        id: "s12",
        html: `<span>Nosotros</span> 
            <select id="story12-1" data-type="irregular"><option value="c">hemos dicho</option><option value="w">hemos decido</option></select>
            <span>la verdad. Los dem√°s</span> 
            <select id="story12-2" data-type="regular"><option value="w">han creyido</option><option value="c">han cre√≠do</option></select>
            <span>nuestra historia.`
    },
    {
        id: "s13",
        html: `<span>Yo</span> 
            <select id="story13-1" data-type="regular"><option value="c">he pagado</option><option value="w">he pague</option></select>
            <span>la cuenta. El camarero ya la</span> 
            <select id="story13-2" data-type="irregular"><option value="c">ha devuelto</option><option value="w">ha devolvido</option></select>
            <span>al cliente.`
    },
    {
        id: "s14",
        html: `<span>T√∫</span> 
            <select id="story14-1" data-type="regular"><option value="w">has comprido</option><option value="c">has comprado</option></select>
            <span>un coche. Yo</span> 
            <select id="story14-2" data-type="regular"><option value="c">he ahorrado</option><option value="w">he ahorre</option></select>
            <span>mucho este a√±o.`
    },
    {
        id: "s15",
        html: `<span>Mi madre</span> 
            <select id="story15-1" data-type="regular"><option value="c">ha cocinado</option><option value="w">ha cocina</option></select>
            <span>mucho. Nosotros</span> 
            <select id="story15-2" data-type="regular"><option value="w">hemos comamos</option><option value="c">hemos comido</option></select>
            <span>toda la comida.`
    },
    {
        id: "s16",
        html: `<span>Ellos</span> 
            <select id="story16-1" data-type="regular"><option value="w">han termino</option><option value="c">han terminado</option></select>
            <span>el proyecto. Yo</span> 
            <select id="story16-2" data-type="irregular"><option value="c">he escrito</option><option value="w">he escribo</option></select>
            <span>el informe final.`
    },
    {
        id: "s17",
        html: `<span>¬øQui√©n</span> 
            <select id="story17-1" data-type="regular"><option value="c">ha bebido</option><option value="w">ha beba</option></select>
            <span>el zumo? Yo no</span> 
            <select id="story17-2" data-type="irregular"><option value="w">he abrido</option><option value="c">he abierto</option></select>
            <span>la nevera.`
    },
    {
        id: "s18",
        html: `<span>Nosotros</span> 
            <select id="story18-1" data-type="regular"><option value="w">hemos salimos</option><option value="c">hemos salido</option></select>
            <span>pronto. ¬øPor qu√© t√∫</span> 
            <select id="story18-2" data-type="irregular"><option value="c">has vuelto</option><option value="w">has devolvido</option></select>
                    <span>tan tarde?`
    },
    {
        id: "s19",
        html: `<span>Mi perro</span> 
            <select id="story19-1" data-type="irregular"><option value="c">ha roto</option><option value="w">ha rompido</option></select>
            <span>el jarr√≥n. ¬°Yo no</span> 
            <select id="story19-2" data-type="irregular"><option value="w">he hacido</option><option value="c">he hecho</option></select>
            <span>nada!`
    },
    {
        id: "s20",
        html: `<span>El pintor</span> 
            <select id="story20-1" data-type="irregular"><option value="c">ha puesto</option><option value="w">ha ponido</option></select>
            <span>su firma. Yo</span> 
            <select id="story20-2" data-type="irregular"><option value="c">he visto</option><option value="w">he ve√≠do</option></select>
            <span>su nueva obra.`
    }
];

// --- LOGIC ---
let currentStoryData = {}; 

document.addEventListener('DOMContentLoaded', () => {
    // Init Tabs
    window.changeMainTab = function(evt, tabId) {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('is-active');
        evt.currentTarget.classList.add('active');
        
        // Lazy load practice
        if (tabId === 'tab-practice' && !document.getElementById('quiz-container').hasChildNodes()) {
            generateQuiz(); 
            generateStory(); 
            generateDragDrop();
        }
        
        // Lazy load flashcards
        if (tabId === 'tab-flashcards') {
            loadCard();
        }
    }

    // Init Acronyms (Original code preserved)
    const acBox = document.getElementById('acronyms');
    irregulars.forEach(i => {
        if(acBox) {
            acBox.innerHTML += `
                <div class="acronym-card" onclick="this.classList.toggle('flipped'); speak('${i.w}... ${i.p}')">
                    <div class="acronym-inner">
                        <div class="acronym-front">${i.l}</div>
                        <div class="acronym-back">${i.w}<br>‚¨áÔ∏è<br><strong>${i.p}</strong></div>
                    </div>
                </div>`;
        }
    });
    
    // Initial calls for practice tab in case the user goes there first
    // Note: These calls are redundant if using `changeMainTab` correctly, but useful for robustness.
    // generateQuiz(); 
    // generateStory(); 
    // generateDragDrop();
});

// 1. QUIZ LOGIC (Original code preserved)
function generateQuiz() {
    const container = document.getElementById('quiz-container');
    container.innerHTML = '';
    const qs = [...quizBank].sort(()=>0.5-Math.random()).slice(0,5); 
    
    qs.forEach((q, idx) => {
        const cleanText = q.q.replace(/[()]/g, " ");
        
        container.innerHTML += `
            <div class="quiz-question">
                <p>${idx+1}. ${q.q} <span class="tts-icon" onclick="speak('${cleanText}')">üîä</span></p>
                <input type="text" id="inp-${idx}" placeholder="Ex: he comido">
                <button onclick="checkQ(${idx}, '${q.a}')">Check</button>
                <span id="fb-${idx}" class="feedback"></span>
            </div>`;
    });
}

window.checkQ = function(idx, ans) {
    const inp = document.getElementById(`inp-${idx}`);
    const fb = document.getElementById(`fb-${idx}`);
    if(inp.value.toLowerCase().trim() === ans.toLowerCase()) {
        fb.textContent = "Correct! ‚úÖ"; fb.className = "feedback correct";
    } else {
        fb.textContent = `Incorrect. It is: ${ans} ‚ùå`; fb.className = "feedback incorrect";
    }
}

// 2. INTERACTIVE STORY LOGIC (CORREGIDO AUDIO)
function generateStory() {
    const container = document.getElementById('story-container');
    currentStoryData = storyBank[Math.floor(Math.random() * storyBank.length)];
    
    // A√±adir el icono de audio a CADA OPCI√ìN del select
    let htmlWithAudio = currentStoryData.html.replace(/<select.*?<\/select>/g, (match) => {
        // Extraer solo la opci√≥n correcta para el audio
        const correctOptionMatch = match.match(/<option value="c">(.*?)<\/option>/);
        const audioText = correctOptionMatch ? correctOptionMatch[1].replace(/<[^>]*>?/gm, '') : 'conjugaci√≥n';
        
        // El audio se reproduce al hacer clic en el bot√≥n de check o en el texto
        return `${match} <span class="tts-icon" onclick="event.stopPropagation(); speak('${audioText}')">üîä</span>`;
    });
    
    container.innerHTML = htmlWithAudio;
    
    container.querySelectorAll('.story-explanation').forEach(e => e.remove());
    container.querySelectorAll('select').forEach(sel => {
         sel.style.borderColor = "#ccc";
    });
}

function checkStory() {
    const container = document.getElementById('story-container');
    container.querySelectorAll('.story-explanation').forEach(e => e.remove());
    
    const selects = container.querySelectorAll('select');
    selects.forEach(sel => {
        const val = sel.value;
        const type = sel.dataset.type;
        const isCorrect = val === 'c';
        
        sel.style.borderColor = isCorrect ? "var(--green)" : "var(--red)";
        
        const exp = document.createElement('span');
        exp.className = 'story-explanation';
        
        if (isCorrect) {
            exp.textContent = "‚úÖ Correcto";
            exp.style.color = "var(--green)";
        } else {
            const correctOption = Array.from(sel.options).find(opt => opt.value === 'c');
            exp.textContent = `‚ùå Incorrecto (Debe ser: ${correctOption ? correctOption.text : 'N/A'})`;
            exp.style.color = "var(--red)";
        }
        
        sel.parentNode.insertBefore(exp, sel.nextSibling);
    });
}

// 3. DRAG & DROP LOGIC (Original code preserved)
const dragPool = document.getElementById('drag-pool');
let currentDragItems = [];

function generateDragDrop() {
    dragPool.innerHTML = '';
    document.getElementById('drag-feedback').textContent = '';
    document.querySelectorAll('.dropzone .draggable').forEach(e=>e.remove());
    
    currentDragItems = [...dragBank].sort(()=>0.5-Math.random()).slice(0,8); 
    
    currentDragItems.forEach(i => {
        const el = document.createElement('div');
        el.className = 'draggable'; el.draggable = true;
        el.innerHTML = `${i.w} <span class="tts-icon" onclick="event.stopPropagation(); speak('${i.w}')">üîä</span>`;
        el.dataset.type = i.t; 
        
        el.addEventListener('dragstart', e => { e.dataTransfer.setData('text', i.t); e.target.classList.add('dragging'); });
        el.addEventListener('dragend', e => e.target.classList.remove('dragging'));
        
        dragPool.appendChild(el);
    });
    
    setupDropzones();
}

function setupDropzones() {
    document.querySelectorAll('.dropzone').forEach(z => {
        z.addEventListener('dragover', e => e.preventDefault());
        z.addEventListener('drop', e => {
            e.preventDefault();
            const dragging = document.querySelector('.dragging');
            if(dragging) z.appendChild(dragging);
        });
    });
}

window.checkDrag = function() {
    let correct = 0;
    const regZone = document.getElementById('zone-regular');
    const irregZone = document.getElementById('zone-irregular');
    
    const checkZone = (zone, type) => {
        zone.querySelectorAll('.draggable').forEach(d => {
            if(d.dataset.type === type) {
                d.style.background = "#d4edda"; correct++;
            } else {
                d.style.background = "#f8d7da";
            }
        });
    };
    
    checkZone(regZone, 'regular');
    checkZone(irregZone, 'irregular');
    
    const total = regZone.querySelectorAll('.draggable').length + irregZone.querySelectorAll('.draggable').length;
    document.getElementById('drag-feedback').textContent = total > 0 ? `Score: ${correct} / ${total}` : "Drag items first!";
}


// 4. FLASHCARDS LOGIC (RESTAURADO)
let cIdx = 0;
function loadCard() {
    const d = flashcards[cIdx];
    // Audio text is the Spanish phrase
    const tts = `&nbsp;<span class="tts-icon" data-tts="${d.es.replace(/<[^>]*>?/gm, '')}">üîä</span>`;
    document.getElementById('fc-front').innerHTML = d.en;
    document.getElementById('fc-back').innerHTML = `${d.es}${tts}<br><br><small style="color:var(--dark-blue)">${d.expl}</small>`;
    document.getElementById('flashcard').classList.remove('is-flipped');
}
window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
window.nextCard = () => { cIdx=(cIdx+1)%flashcards.length; loadCard(); };
window.prevCard = () => { cIdx=(cIdx-1+flashcards.length)%flashcards.length; loadCard(); };

// Audio Click Handler for Flashcards
document.body.addEventListener('click', function(e) {
    if(e.target.classList.contains('tts-icon')) {
        e.stopPropagation(); // Stop flip
        speak(e.target.dataset.tts);
    } else if(e.target.closest('#flashcard')) {
        flipCard();
    }
});

// UI Functions (Original code preserved)
window.toggleLang = function() {
    currentLang = currentLang === 'en' ? 'es' : 'en';
    document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.dataset.langKey;
        if(uiData[currentLang][key]) el.innerHTML = uiData[currentLang][key];
    });
}

window.toggleTheme = () => document.body.classList.toggle('dark-mode');

// AUDIO ENGINE (Original code preserved)
function speak(txt) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.lang = 'es-ES';
    
    const voices = window.speechSynthesis.getVoices();
    let v = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('es')); 
    if (!v) v = voices.find(voice => (voice.name.includes('Monica') || voice.name.includes('Paulina')) && voice.lang.includes('es')); 
    if (!v) v = voices.find(voice => voice.lang.includes('es')); 
    
    if(v) u.voice = v;
    window.speechSynthesis.speak(u);
}

window.speechSynthesis.onvoiceschanged = () => {}; 
</script>
</body>
</html>
